<!doctype html>
<html lang="en">
<head>
  <!--
    The Archive ‚Ä¢ Master of the Scrolls
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    Purpose
      ‚Ä¢ Present a calm, systems‚Äëgrade dashboard "face" for the Archive (ü´Ä)
      ‚Ä¢ Read registry.yaml (+ light validation) to compute integrity KPIs
      ‚Ä¢ Render README.md for human context
      ‚Ä¢ Link out to the lifeblood seeds (glossary.yml, tags.yml) in the hub repo

    How to use
      1) Drop this file at the repo root as index.html (works with GitHub Pages)
      2) Ensure registry.yaml and registry.schema.yaml live in the same directory
      3) Optional: update HUB_URL and SEEDS_* links below to match your setup
  -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>ü´Ä The Archive ‚Äî Master of the Scrolls</title>

  <!-- Optional: Google Tag Manager (prefer GTM for analytics plumbing) -->
  <!--
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
      j.async=true; j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl; f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-XXXXXXX');
  </script>
  -->

  <style>
    :root{
      --bg: #0b0d10;          /* near-black */
      --panel: #12161b;      /* deep slate */
      --ink: #e7edf3;        /* soft white */
      --muted: #9fb0c3;      /* slate blue-gray */
      --accent: #ff3b81;     /* pulse pink */
      --ok: #22c55e;         /* green */
      --warn: #f59e0b;       /* amber */
      --bad: #ef4444;        /* red */
      --card: #151a20;       /* card surface */
      --chip: #1b2129;       /* chip surface */
      --border: #273241;     /* hairline */
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7fafc; --panel:#ffffff; --ink:#0b1220; --muted:#516076; --accent:#d81b60;
        --ok:#16a34a; --warn:#d97706; --bad:#dc2626; --card:#ffffff; --chip:#f1f5f9; --border:#e2e8f0;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg); color:var(--ink);
    }
    a{color:inherit}
    .wrap{max-width:1152px; margin:0 auto; padding:24px}
    header{
      display:flex; align-items:center; gap:16px; flex-wrap:wrap; margin-bottom:16px;
    }
    .back{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px;
      background:var(--chip); color:var(--ink); text-decoration:none; border:1px solid var(--border);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .heart{
      width:44px; height:44px; border-radius:12px; display:grid; place-items:center;
      background:linear-gradient(145deg, #2a1220, #1a0b14); border:1px solid #3c1a2a;
      position:relative; overflow:hidden;
    }
    .heart::after{
      content:""; position:absolute; inset:0; background:radial-gradient(circle at 60% 40%, rgba(255,59,129,.25), transparent 55%);
      mix-blend-mode:screen; pointer-events:none;
    }
    .pulse{animation:pulse 2s ease-in-out infinite; font-size:22px}
    @keyframes pulse{ 0%,100%{ transform:scale(.96) } 50%{ transform:scale(1.06) } }
    h1{font-size:24px; margin:0}
    .tagline{color:var(--muted); font-size:14px}

    .grid{display:grid; gap:16px}
    .kpis{grid-template-columns:repeat(4, minmax(0,1fr))}
    @media (max-width:980px){ .kpis{grid-template-columns:repeat(2, minmax(0,1fr))} }
    @media (max-width:560px){ .kpis{grid-template-columns:1fr} }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px;
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
    }
    .card h3{margin:0 0 8px 0; font-size:16px; letter-spacing:.2px}
    .metric{display:flex; align-items:baseline; gap:10px}
    .metric .value{font-size:28px; font-weight:700}
    .metric .sub{color:var(--muted); font-size:13px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}

    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{background:var(--chip); border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px}

    .section-title{display:flex; align-items:center; justify-content:space-between; margin:24px 0 8px}
    .section-title h2{margin:0; font-size:18px}

    details.project{border:1px solid var(--border); border-radius:12px; background:var(--panel)}
    details.project summary{
      display:flex; align-items:center; gap:10px; cursor:pointer; padding:12px 14px; list-style:none; font-weight:600;
    }
    details.project[open] summary{border-bottom:1px solid var(--border)}
    .project-body{padding:12px 14px}
    .project-meta{display:flex; flex-wrap:wrap; gap:8px; margin:8px 0}

    .toolbar{display:flex; flex-wrap:wrap; gap:10px}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:var(--chip); text-decoration:none}

    .readme{padding:0}
    .readme .md{padding:16px}
    .readme .md :is(h1,h2,h3){margin-top:1.25em}
    .readme .md pre{background:var(--chip); padding:12px; border-radius:8px; overflow:auto}
    .readme .md code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}

    .status-dot{width:10px; height:10px; border-radius:50%}
    .row{display:flex; align-items:center; gap:8px}
    .muted{color:var(--muted)}
    footer{margin:24px 0; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="back" href="https://zbreeden.github.io/FourTwentyAnalytics/" title="Back to Hub">‚Üê Back</a>
      <div class="brand">
        <div class="heart" aria-hidden="true"><div id="pulse" class="pulse">ü´Ä</div></div>
        <div>
          <h1>The Archive</h1>
          <div class="tagline">Master of the Scrolls ‚Ä¢ steward of seeds ‚Ä¢ system heartbeat</div>
        </div>
      </div>
    </header>

    <section class="grid kpis" id="kpi-cards">
      <div class="card">
        <h3>Total Projects</h3>
        <div class="metric"><div class="value" id="kpi-projects">‚Äî</div><div class="sub">from registry.yaml</div></div>
      </div>
      <div class="card">
        <h3>Archives</h3>
        <div class="metric"><div class="value" id="kpi-archives">‚Äî</div><div class="sub" id="kpi-archives-sub">last: ‚Äî</div></div>
      </div>
      <div class="card">
        <h3>QA pass rate</h3>
        <div class="metric"><div class="value" id="kpi-qa">‚Äî</div><div class="sub">label: <code>qa_passed</code></div></div>
      </div>
      <div class="card">
        <h3>Schema health</h3>
        <div class="row"><div id="schema-dot" class="status-dot" style="background:var(--warn)"></div><div id="schema-text">checking‚Ä¶</div></div>
        <div class="chips" id="schema-issues" style="margin-top:10px"></div>
      </div>
    </section>

    <div class="section-title">
      <h2>Registry overview</h2>
      <div class="toolbar">
        <button class="btn" id="refresh">‚Üª Refresh</button>
        <button class="btn" id="export">‚¨áÔ∏é Export heartbeat</button>
        <a class="btn" href="registry.yaml" target="_blank" rel="noopener">Open registry.yaml</a>
        <a class="btn" href="registry.schema.yaml" target="_blank" rel="noopener">Open schema</a>
      </div>
    </div>

    <section class="grid" id="orbit-groups"></section>

    <div class="section-title"><h2>Seeds in the hub (lifeblood)</h2></div>
    <section class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr))">
      <div class="card">
        <h3>glossary.yml</h3>
        <div class="chips">
          <a class="btn" href="https://github.com/zbreeden/FourTwentyAnalytics/blob/main/seeds/glossary.yml" target="_blank" rel="noopener">View on GitHub</a>
          <a class="btn" href="https://raw.githubusercontent.com/zbreeden/FourTwentyAnalytics/refs/heads/main/seeds/glossary.yml" target="_blank" rel="noopener">Raw</a>
        </div>
        <p class="muted" style="margin-top:10px">Source of human‚Äëfacing terms. The Archive ensures consistency and drift checks.</p>
      </div>
      <div class="card">
        <h3>tags.yml</h3>
        <div class="chips">
          <a class="btn" href="https://github.com/zbreeden/FourTwentyAnalytics/blob/main/seeds/tags.yml" target="_blank" rel="noopener">View on GitHub</a>
          <a class="btn" href="https://raw.githubusercontent.com/zbreeden/FourTwentyAnalytics/refs/heads/main/seeds/tags.yml" target="_blank" rel="noopener">Raw</a>
        </div>
        <p class="muted" style="margin-top:10px">Machine‚Äëtethered tags that flow across modules. The Archive is the source of truth for lineage.</p>
      </div>
    </section>

    <div class="section-title"><h2>README</h2></div>
    <section class="card readme">
      <div id="readme" class="md">Loading README.md‚Ä¶</div>
    </section>

    <footer id="stamp">‚Äî</footer>
  </div>

  <!-- Libraries: YAML + Markdown parsers -->
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>

  <script>
    // Config
    const HUB_URL = "https://zbreeden.github.io/FourTwentyAnalytics/"; // back button target

    // Utilities
    const fmtPercent = (n) => (isFinite(n) ? (n*100).toFixed(0) + "%" : "‚Äî");
    const el = (sel) => document.querySelector(sel);
    const ago = (iso) => {
      const d = new Date(iso + 'T00:00:00');
      const now = new Date();
      const days = Math.floor((now - d)/86400000);
      return isFinite(days) ? `${days}d ago` : "‚Äî";
    };

    // Light schema checks (non‚Äëblocking; ensures guardrails even without AJV)
    function lightValidate(reg){
      const issues = [];
      if (!reg || typeof reg !== 'object') issues.push('registry not an object');
      if (!reg.version) issues.push('missing version');
      if (!Array.isArray(reg.labels)) issues.push('labels not array');
      if (!Array.isArray(reg.projects)) issues.push('projects not array');
      (reg.projects||[]).forEach((p,i)=>{
        ['id','name','emoji','type','repo','archives'].forEach(k=>{ if(!(k in p)) issues.push(`project[${i}] missing ${k}`); });
        if (!Array.isArray(p.archives)) issues.push(`project[${i}].archives not array`);
      });
      return issues;
    }

    async function fetchText(path){
      const res = await fetch(path, {cache:'no-store'});
      if (!res.ok) throw new Error(`${path}: ${res.status}`);
      return await res.text();
    }

    async function load(){
      try{
        // Load registry + schema (schema not strictly required for the face; we display it alongside)
        const [regText, schemaText, readmeMd] = await Promise.all([
          fetchText('registry.yaml').catch(()=>''),
          fetchText('registry.schema.yaml').catch(()=>''),
          fetchText('README.md').catch(()=>''),
        ]);

        const registry = regText ? jsyaml.load(regText) : null;
        const schema = schemaText ? jsyaml.load(schemaText) : null; // displayed only; deep validation omitted by design

        // KPIs from registry
        let projects = [], labels = [], archiveCount = 0, lastArchive = null, qaCount = 0;
        if (registry){
          projects = Array.isArray(registry.projects) ? registry.projects : [];
          labels = Array.isArray(registry.labels) ? registry.labels : [];
          projects.forEach(p=>{
            (p.archives||[]).forEach(a=>{
              archiveCount++;
              if (!lastArchive || (a.date && a.date > lastArchive)) lastArchive = a.date;
              if (Array.isArray(a.labels) && a.labels.includes('qa_passed')) qaCount++;
            });
          });
        }

        // Populate KPI cards
        el('#kpi-projects').textContent = projects.length || '0';
        el('#kpi-archives').textContent = archiveCount || '0';
        el('#kpi-archives-sub').textContent = lastArchive ? `last: ${lastArchive} ‚Ä¢ ${ago(lastArchive)}` : 'no archives yet';
        el('#kpi-qa').textContent = fmtPercent(archiveCount ? (qaCount / archiveCount) : NaN);

        <div class="section-title"><h2>System Health (modules index)</h2></div>
        <section class="card" id="modules-health">
        <div id="modules-health-body">Loading‚Ä¶</div>
        </section>

        // Schema/guardrail status
        const issues = lightValidate(registry);
        const dot = el('#schema-dot');
        const text = el('#schema-text');
        const list = el('#schema-issues');
        list.innerHTML = '';
        if (!registry){
          dot.style.background = 'var(--warn)';
          text.textContent = 'registry.yaml not found';
        } else if (issues.length){
          dot.style.background = 'var(--warn)';
          text.textContent = `${issues.length} issue${issues.length>1?'s':''}`;
          issues.slice(0,6).forEach(i=>{ const b=document.createElement('span'); b.className='chip'; b.textContent=i; list.appendChild(b); });
        } else {
          dot.style.background = 'var(--ok)';
          text.textContent = 'healthy';
        }

        // Render orbit groups
        const groups = new Map();
        projects.forEach(p=>{
          const key = p.orbit || 'Ungrouped';
          if (!groups.has(key)) groups.set(key, []);
          groups.get(key).push(p);
        });
        const container = el('#orbit-groups');
        container.innerHTML = '';
        if (groups.size===0){ container.innerHTML = '<div class="muted">No projects found in registry.</div>'; }
        groups.forEach((items, orbit)=>{
          const box = document.createElement('div');
          box.className = 'card';
          const title = document.createElement('div');
          title.className = 'section-title';
          title.innerHTML = `<h2>${orbit}</h2>`;
          box.appendChild(title);

          items.forEach((p,idx)=>{
            const d = document.createElement('details');
            d.className = 'project';
            d.innerHTML = `
              <summary>${p.emoji||''} <span>${p.name}</span> <span class="muted" style="font-weight:400">‚Ä¢ ${p.type}</span></summary>
              <div class="project-body">
                <div class="project-meta">
                  <span class="chip"><strong>ID:</strong> ${p.id}</span>
                  <span class="chip"><strong>Repo:</strong> <a href="${p.repo}" target="_blank" rel="noopener">open</a></span>
                  <span class="chip"><strong>Archives:</strong> ${(p.archives||[]).length}</span>
                </div>
                <div>
                  ${(p.archives||[]).slice().reverse().slice(0,5).map(a=>{
                    const hasQA = Array.isArray(a.labels) && a.labels.includes('qa_passed');
                    const qaSpan = hasQA ? '<span class="chip" style="border-color:transparent; background:rgba(34,197,94,.15)">‚úÖ QA</span>' : '';
                    const labels = Array.isArray(a.labels) ? a.labels.map(l=>`<span class='chip'>${l}</span>`).join(' ') : '';
                    return `<div class='row' style='justify-content:space-between'>
                              <div>
                                <strong>${a.date||'‚Äî'}</strong>
                                <span class='muted' style='margin-left:8px'>${a.tag||''}</span>
                              </div>
                              <div class='chips'>${qaSpan} ${labels}</div>
                            </div>`;
                  }).join('')}
                </div>
              </div>`;
            if (idx===0) d.setAttribute('open','');
            box.appendChild(d);
          });
          container.appendChild(box);
        });

        // README render (best-effort)
        const readme = el('#readme');
        if (readmeMd){ readme.innerHTML = marked.parse(readmeMd); }
        else { readme.textContent = 'README.md not found'; }

        // Stamp
        const now = new Date();
        const dt = now.toLocaleString('en-GB', {hour12:false, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}).replace(',', '');
        el('#stamp').textContent = `Face rendered ‚Ä¢ ${dt}`;

        // Pulse color reacts to health
        el('#pulse').style.filter = (issues.length? 'drop-shadow(0 0 12px var(--warn))' : 'drop-shadow(0 0 12px var(--ok))');
      }catch(err){
        console.error(err);
        alert('Failed to load dashboard face. See console for details.');
      }
    }

    // Wire controls
    window.addEventListener('DOMContentLoaded', ()=>{
      el('#refresh').addEventListener('click', load);
      el('#export').addEventListener('click', ()=>{
        const data = {
          generated_at: new Date().toISOString(),
          href: location.href,
          // Minimal heartbeat payload; fetch live values from the DOM to keep export simple
          kpis: {
            total_projects: el('#kpi-projects').textContent,
            total_archives: el('#kpi-archives').textContent,
            qa_pass_rate_display: el('#kpi-qa').textContent,
            last_archive_display: el('#kpi-archives-sub').textContent
          }
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const ts = new Date().toISOString().replace(/[-:T.]/g,'').slice(0,12);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `archive_heartbeat_${ts}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      });
      load();
    });
  </script>

<script>
async function loadModulesHealth(){
  const host = document.getElementById('modules-health-body');
  try{
    const res = await fetch('archive/modules_index.json', { cache:'no-store' });
    if(!res.ok) throw new Error(res.status);
    const idx = await res.json();
    const mods = idx.modules || [];
    if(!mods.length){ host.textContent = 'No modules indexed yet.'; return; }

    const rows = mods.map(m=>{
      const counts = m.counts || {};
      const seeds  = (m.seeds_found||[]).map(s => s.split('/').pop()).join(', ') || '‚Äî';
      return `
        <tr>
          <td><code>${m.repo}</code></td>
          <td><code>${m.branch||''}</code></td>
          <td class="num">${counts.statuses||0}</td>
          <td class="num">${counts.glossary||0}</td>
          <td class="num">${counts.tags||0}</td>
          <td>${seeds}</td>
          <td class="muted">${m.last_pulsed_utc||'‚Äî'}</td>
        </tr>
      `;
    }).join('');

    host.innerHTML = `
      <div class="muted" style="margin-bottom:8px">
        Source: <code>archive/modules_index.json</code>
      </div>
      <div style="overflow:auto">
        <table class="health">
          <thead>
            <tr>
              <th>Repo</th><th>Branch</th><th>Statuses</th><th>Glossary</th><th>Tags</th><th>Seeds Found</th><th>Last Pulsed</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }catch(e){
    host.textContent = 'Failed to load modules_index.json';
  }
}
document.addEventListener('DOMContentLoaded', loadModulesHealth);
</script>

<style>
  table.health{width:100%; border-collapse:collapse; font-size:14px}
  table.health th, table.health td{border-bottom:1px solid var(--border); padding:8px 10px; text-align:left}
  table.health th:nth-child(3),
  table.health th:nth-child(4),
  table.health th:nth-child(5),
  table.health td.num{ text-align:right }
</style>

</body>
</html>
